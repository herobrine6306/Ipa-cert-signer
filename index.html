<form id="uploadForm" enctype="multipart/form-data">
    <label for="ipa">Upload IPA File:</label>
    <input type="file" id="ipa" name="ipa" accept=".ipa" required>
    
    <label for="cert">Upload Signing Certificate (.p12 or .pem):</label>
    <input type="file" id="cert" name="cert" accept=".p12,.pem" required>
    
    <button type="submit">Sign & Install</button>
</form>

<script>
document.getElementById('uploadForm').onsubmit = async function (e) {
    e.preventDefault();
    
    const ipaFile = document.getElementById('ipa').files[0];
    const certFile = document.getElementById('cert').files[0];
    
    if (!ipaFile || !certFile) {
        alert('Please upload both an IPA file and a signing certificate.');
        return;
    }
    
    // Upload IPA and certificate files to the server for signing
    const formData = new FormData();
    formData.append('ipa', ipaFile);
    formData.append('cert', certFile);
    
    // Send files to the backend
    const response = await fetch('/sign-and-install', {
        method: 'POST',
        body: formData
    });

    const result = await response.json();

    if (result.success) {
        // This triggers the installation prompt
        window.location.href = `itms-services://?action=download-manifest&url=${result.plist_url}`;
    } else {
        alert('Signing failed. Please check the certificate or try again.');
    }
};
</script>
